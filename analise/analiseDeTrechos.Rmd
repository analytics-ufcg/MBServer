---
title: "Analise de pernas de ônibus"
author: "Luiz Alberto Fonseca"
date: "September 5, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(ggplot2)
library(tidyverse)
library(resample)
```

Primeiramente importaremos os dados:

```{r}
dados.bulma <- read_csv("dadostratados.csv")
```

Vamos ver como se comportam as durações durante o dia:

```{r}
dados.bulma %>% 
  ggplot(aes(x = as.factor(hourOrig), y = duration)) +
  geom_boxplot()
```

Vemos que apenas os horários abaixo das 7 horas e acima das 18 horas parecem ser menores que os demais.

Vamos comparar a hora com as demais horas do dia, ou seja, para cada dia, como se comporta aquela hora em comparação com as demais:

```{r}
summarised.dates <- dados.bulma %>% group_by(date) %>%
  summarise(meanDuration = mean(duration),
            medianDuration = median(duration))

temp1 <- dados.bulma %>% select(date, hourOrig, hourDest, duration)
temp1 <- left_join(temp1, summarised.dates, by = "date")

# Diferença entre cada duração e a duração mediana do dia
temp1 <- temp1 %>% mutate(
  diffFromMedian = duration - medianDuration
)

# Mediana das diferenças por hora
temp2 <- temp1 %>% group_by(hourOrig) %>%
  summarise(
   medianOfDiffs = median(diffFromMedian)
)

# plot
ggplot(temp2, aes(as.factor(hourOrig), medianOfDiffs)) +
  geom_bar(stat = "identity", fill = "#2f4c56", legend = FALSE) + 
  scale_y_continuous("Média das diferenças (em segundos)") +
  theme(axis.title.x = element_blank()) +
  labs(title = "Mediana das diferenças entre as durações de viagens e a duração mediana do dia")

```

Podemos perceber que parece existir dois horários de pico, das 7 as 8 horas e das 14 as 18 horas.

Vejamos se realmente existe uma diferença significativa:

```{r}
set.seed(66)

boot.dados.bulma.by.hour <- dados.bulma %>% 
  group_by(hourOrig) %>% 
  summarise(
    y.025 = CI.bca(bootstrap(data = duration, statistic = mean, seed = 66, R = 100), probs = c(.025, .975))[1],
    y.975 = CI.bca(bootstrap(data = duration, statistic = mean, seed = 66, R = 100), probs = c(.025, .975))[2]
  )

boot.dados.bulma.by.hour %>% 
  ggplot(aes(x = hourOrig, ymin = y.025, ymax = y.975)) +
  geom_errorbar()
```

Podemos ver que os horários de pico determinados anteriormente, entre 7 e 8 horas tem viagens com duração maior que as anteriores e maiores que as viagens após as 19 horas, mas não se pode concluir nada sobre as demais. Definitivamente 18 horas é um horário de pico, visto que é maior que as demais.

## Dia da semana
Vejamos agora as durações para cada dia da semana:

```{r}
boot.dados.bulma.by.weekday <- dados.bulma %>% 
  group_by(weekDay) %>% 
  summarise(
    y.025 = CI.bca(bootstrap(data = duration, statistic = mean, seed = 66, R = 100), probs = c(.025, .975))[1],
    y.975 = CI.bca(bootstrap(data = duration, statistic = mean, seed = 66, R = 100), probs = c(.025, .975))[2]
  )

boot.dados.bulma.by.weekday %>% 
  mutate(weekDay = factor(weekDay, levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))) %>% 
  arrange(weekDay) %>% 
  ggplot(aes(x = weekDay, ymin = y.025, ymax = y.975)) +
  geom_errorbar()
```

Podemos perceber que o dia em que os ônibus mais demoram é a segunda-feira, visto que é o único que existe uma diferença significativa de duração em relação aos demais. A quinta-feira também tem uma duração mais elevada quando comparada aos demais, exceto à segunda-feira e quarta-feira.

Vejamos agora outra abordagem, a diferença da duração da viagem em relação à duração mediana semanal.

```{r}
summarised.weeks <- dados.bulma %>% group_by(weekOfYear) %>%
  summarise(medianWeek = median(duration))

temp3 <- dados.bulma %>% select(weekOfYear, weekDay, duration)
temp3 <- left_join(temp3, summarised.weeks, by = "weekOfYear")

# Diferença entre cada duração e a duração mediana da semana
temp3 <- temp3 %>% mutate(
  diffFromMedian = duration - medianWeek
)

# Mediana das diferenças por dia da semana
temp4 <- temp3 %>% group_by(weekDay) %>%
  summarise(
   medianOfDiffs = median(diffFromMedian)
)

temp4 %>% 
  mutate(weekDay = factor(weekDay, levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))) %>% 
  arrange(weekDay) %>% 
  ggplot(aes(as.factor(weekDay), medianOfDiffs)) +
    geom_bar(stat = "identity", fill = "#2f4c56", legend = FALSE) + 
    scale_y_continuous("Média das diferenças (em segundos)") +
    theme(axis.title.x = element_blank()) +
    labs(title = "Quanto (em média) a mediana das durações de cada dia da semana difere \nda mediana das durações da semana")
```

Podemos ber que, assim como visto acima, a segunda-feira é o dia que tem maior diferença da duração em relação a mediana semanal, seguido pela quinta-feira.

## Área da cidade

```{r}
library(ggmap)

city.area <- dados.bulma %>% select(shapeLatOrig, shapeLonOrig, busStopIdOrig, busStopIdDest, shapeLatDest, shapeLonDest, velocityKmh)

m <- get_map("Curitiba",zoom=11,maptype="roadmap",source="google")

g <- ggmap(m)
g +
  stat_density2d(aes(x = shapeLonOrig, y = shapeLatOrig, fill=duration, colour = duration), data=dados.bulma,geom="polygon", alpha=0.2) +
  scale_fill_gradient(low = "yellow", high = "red")

g +
  geom_point(aes(x = shapeLonOrig, y = shapeLatOrig, color = duration), data = dados.bulma) + 
  geom_point(size=3,alpha=1)

# ggmap(m) + 
#   geom_density2d(data = dados.bulma, aes(x = shapeLonOrig, y = shapeLatOrig), size = 0.3) +
#   stat_density2d(data = dados.bulma, aes(x = shapeLonOrig, y = shapeLatOrig, fill = duration, alpha = duration), 
#                  size = 0.01, bins = 16, geom = "polygon") +
#   scale_fill_gradient(low = "green", high = "red") + 
#   scale_alpha(range = c(0, 0.3), guide = FALSE)
```

Podemos ver que a região da cudade com maior duração é o centro.

Vamos fazer um grid com a latitude entre -25.67 e -25.33 e longitude entre -49.40 e -49.07.

```{r}
lat.min <- -25.67
lat.max <- -25.32
lon.min <- -49.40
lon.max <- -49.07

lat.step <- (lat.max - lat.min) / 50
lon.step <- (lon.max - lon.min) / 50

dados.bulma.grid <- dados.bulma %>% 
  mutate(
    lat.grid.index = floor((shapeLatOrig - lat.min) / lat.step),
    lon.grid.index = floor((shapeLonOrig - lon.min) / lon.step)
  )

g +
  geom_point(aes(x = shapeLonOrig, y = shapeLatOrig, color = as.factor(lat.grid.index)), data = dados.bulma.grid) + 
  geom_point(size=3,alpha=1)

g +
  geom_point(aes(x = shapeLonOrig, y = shapeLatOrig, color = as.factor(lon.grid.index)), data = dados.bulma.grid) + 
  geom_point(size=3,alpha=1)
```

